<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance | Student Dashboard</title>

<style>
:root{
  --primary:#1e40af;
  --accent:#3b82f6;
  --bg:#f1f5f9;
  --dark:#1e293b;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui}

body{
  background:var(--bg);
  height:100vh;
  display:flex;
  overflow:hidden;
}

/* SIDEBAR */
.sidebar{
  width:220px;
  background:#0f172a;
  color:white;
  padding:40px 0;
  display:flex;
  flex-direction:column;
}
.brand{
  font-size:24px;
  font-weight:800;
  padding:0 30px;
  margin-bottom:40px;
}
.nav-link{
  padding:14px 30px;
  display:block;
  color:#94a3b8;
  text-decoration:none;
  font-weight:600;
}
.nav-link.active{
  background:#1e293b;
  color:white;
  border-left:5px solid var(--accent);
}
.logout{
  margin-top:auto;
  padding:15px 30px;
  color:#ef4444;
  font-weight:600;
  cursor:pointer;
}

/* MAIN */
.main{
  flex:1;
  padding:35px;
  display:flex;
  flex-direction:column;
  gap:20px;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header h1{
  font-size:28px;
  color:var(--dark);
}
.controls{
  display:flex;
  gap:12px;
}
.controls select{
  padding:10px 14px;
  border-radius:14px;
  border:1px solid #cbd5e1;
}
.add-btn{
  padding:10px 22px;
  border-radius:20px;
  border:none;
  background:var(--accent);
  color:white;
  font-weight:700;
  cursor:pointer;
}

/* LIST */
.list{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.att-card{
  background:white;
  border-radius:18px;
  padding:16px 20px;
  display:grid;
  grid-template-columns:1.2fr 1fr 1fr 1fr auto;
  align-items:center;
  box-shadow:0 6px 15px rgba(0,0,0,.05);
}
.att-card b{color:var(--primary)}
.actions button{
  border:none;
  width:32px;
  height:32px;
  border-radius:50%;
  cursor:pointer;
  font-weight:700;
}
.edit{background:#dcfce7;color:#166534}
.del{background:#fee2e2;color:#991b1b}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:center;
}
.modal-box{
  background:white;
  width:360px;
  border-radius:20px;
  padding:25px;
}
.modal-box h3{
  margin-bottom:15px;
}
.modal-box input,
.modal-box select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #cbd5e1;
  margin-bottom:12px;
}
.modal-box button{
  width:100%;
  padding:12px;
  border-radius:20px;
  border:none;
  background:var(--primary);
  color:white;
  font-weight:700;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="brand">Edural</div>
  <a class="nav-link" href="dashboard.html">Dashboard</a>
  <a class="nav-link" href="marks.html">Marks</a>
  <a class="nav-link active">Attendance</a>
  <a class="nav-link" href="about.html">About</a>
  <a class="nav-link" href="contact.html">Contact</a>
  <div class="logout" onclick="logout()">Logout</div>
</aside>

<!-- MAIN -->
<main class="main">

<div class="header">
  <h1>Attendance</h1>
  <div class="controls">
    <select id="semesterFilter">
      <option value="all">All Semesters</option>
      <option value="1">Semester 1</option>
      <option value="2">Semester 2</option>
    </select>
    <button id="addBtn" class="add-btn">+ Add / Update</button>
  </div>
</div>

<div id="list" class="list"></div>

</main>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Attendance</h3>

    <select id="subject">
      <option>English</option>
      <option>Mathematics</option>
      <option>HTML & CSS</option>
      <option>JavaScript</option>
      <option>Python</option>
    </select>

    <select id="semester">
      <option value="1">Semester 1</option>
      <option value="2">Semester 2</option>
    </select>

    <input type="number" id="present" placeholder="Classes Attended">
    <input type="number" id="total" placeholder="Total Classes">

    <button onclick="save()">Save Attendance</button>
  </div>
</div>

<script>
/* AUTH */
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser) location.href="login.html";

/* DATA */
let students = JSON.parse(localStorage.getItem("students")) || [];
let student = students.find(s=>s.email===currentUser.email);

if(!student){
  student = { email: currentUser.email, attendance: [] };
  students.push(student);
}

student.attendance ||= [];
localStorage.setItem("students", JSON.stringify(students));

const list = document.getElementById("list");
const modal = document.getElementById("modal");
const addBtn = document.getElementById("addBtn");
const semesterFilter = document.getElementById("semesterFilter");

let editIndex = null;

/* PERMISSION */
if(!currentUser.isTeacher){
  addBtn.style.display="none";
}

/* RENDER */
function render(){
  list.innerHTML="";
  const sem = semesterFilter.value;

  student.attendance.forEach((a,i)=>{
    if(sem!=="all" && a.semester!==sem) return;

    list.innerHTML += `
      <div class="att-card">
        <b>${a.subject}</b>
        <span>Semester ${a.semester}</span>
        <span>${a.attendedClasses}/${a.totalClasses}</span>
        <span>${a.percentage}%</span>
        ${
          currentUser.isTeacher
          ? `<div class="actions">
               <button class="edit" onclick="edit(${i})">✎</button>
               <button class="del" onclick="remove(${i})">✕</button>
             </div>`
          : ``
        }
      </div>`;
  });
}
render();

/* FILTER */
semesterFilter.onchange = render;

/* MODAL */
addBtn.onclick = ()=>{
  editIndex=null;
  present.value = "";
  total.value = "";
  modalTitle.innerText = "Add / Update Attendance";
  modal.style.display="flex";
};
modal.onclick = e=>{
  if(e.target===modal) modal.style.display="none";
};

/* SAVE (CORRECT APPROACH) */
function save(){
  if(!present.value || !total.value) return;

  const record = {
    subject: subject.value,
    semester: semester.value,
    attendedClasses: +present.value,
    totalClasses: +total.value
  };
  record.percentage = Math.round(
    (record.attendedClasses / record.totalClasses) * 100
  );

  const index = student.attendance.findIndex(
    a => a.subject===record.subject && a.semester===record.semester
  );

  if(index !== -1){
    student.attendance[index] = record;
  }else{
    student.attendance.push(record);
  }

  localStorage.setItem("students", JSON.stringify(students));
  modal.style.display="none";
  render();
}

/* EDIT */
function edit(i){
  const a = student.attendance[i];
  subject.value = a.subject;
  semester.value = a.semester;
  present.value = a.attendedClasses;
  total.value = a.totalClasses;
  modal.style.display="flex";
}

/* DELETE */
function remove(i){
  student.attendance.splice(i,1);
  localStorage.setItem("students", JSON.stringify(students));
  render();
}

/* LOGOUT */
function logout(){
  localStorage.removeItem("currentUser");
  location.href="login.html";
}
</script>

</body>
</html>
